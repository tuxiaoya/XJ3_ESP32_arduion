/*
  String length()

  Examples of how to use length() in a String.
  Open the Serial Monitor and start sending characters to see the results.
  created 1 Aug 2010
  by Tom Igoe

  This example code is ???????? ???????? GIT

  move  HWSG to GITHUB
  1-3
  // #include "nbiot_m5310.c"
  http://www.arduino.cc/en/Tutorial/StringLengthTrim
*/
#include <HardwareSerial.h>
#include "DIWEN_480.h"
#include <Ticker.h>
#include "MG_HWSG_2C.H"


uint64_t chipid;

struct NB_5310_RES
{
  bool status;
  String data;
  String temp;
};



Ticker ticker_HWSG;  // 
// Ticker tickerSetLow;

//String logo="MINGUANG CO.LTD";
//String inputString = "";         // a String to hold incoming data
//bool stringComplete = false;  // whether the string is complete

ESP  myesp32;
DIWEN480  MyDIWEN

HardwareSerial M5310_Serial(0);
HardwareSerial DIWEN_Serial(1);
HardwareSerial HWSG_Serial(2);
bool ONENET_online = false;


//
//String txtMsg = "";                         // a string for incoming text
//unsigned int lastStringLength = txtMsg.length();     // previous length of the String

void setup() {

  chipid = myesp32.getEfuseMac();                                  //The chip ID is essentially its MAC address(length: 6 bytes).
  Serial.printf("ESP32 Chip ID = %04X", (uint16_t)(chipid >> 32)); //print High 2 bytes
  Serial.printf("%08X\n", (uint32_t)chipid);                       //print Low 4bytes.

  // Open serial communications and wait for port to open:
  M5310_Serial.begin(9600);  // é–¿ç†·â‚?ç†·çµ½æ¿¡ã‚†ç¹ˆæ¿®æ ?î”¡å?—å Ÿå«¹é—‚å›§ç‰Šé‹ç†¼î” éƒæ’´å?¹æ?ä½¹ç‰?éŽ·ï¿½ t
  // DIWEN_Serial.begin(115200, SERIAL_8N1, 17, 16);  //  rxPin, txPin
  HWSG_Serial.begin(1200, SERIAL_8N1, 18, 19);  //  rxPin, txPin
  while (!M5310_Serial) {
    ; // wait for serial port to connect. Needed for native USB port only
  }  


  if(setup_M5310()) {
    DisMessage(0,"M5310 INIT Succese!",dc_white); 
    DisMessage(1,"New SIGN to ONENET ...........",dc_white);
    if(MIPLADDOBJ()){ // //??????????????????????
    DisMessage(0,"M5310 ADDOBJ Succese!",dc_white);         
      }    
    }
  else{
    DisMessage(0,"M5310 INIT  falsed!!!",dc_red); 
    DisMessage(1,"-------------",dc_white);    
    }

  ticker_HWSG.attach(1, Call_HWSG);   //??????1???????????????????ll_HWSG  upload tem  
}

void loop() {

}

void DisMessage(char No_place, String msg, uint16_t dcc)
{

  switch (No_place)
  {
  case 0: //
    DisStrings(0x42, dcc, 0x0000, dpx0, 460, msg);
    break;
  case 1: // your hand is close to the sensor
    DisStrings(0x42, dcc, 0x0000, dpx1, 460, msg);
    break;
  case 2: // your hand is close to the sensor
    DisStrings(0x42, dcc, 0x0000, dpx2, 460, msg);
    break;
  case 3: // your hand is close to the sensor
    DisStrings(0x41, dcc, 0x0000, 0, 0, msg);
    break;
  }
}

//const String  AT_command_5310[4]={
//  "AT\r\n", //??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????  
//  "AT+CSQ\r\n",// ?????????????????????????????????????????????????????????????????????????
//  "AT+CEREG?\r\n",// ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
//  "AT+CGATT?\r\n",//????????????????????????????????????????????????? PS ?????????????????????????????????????????????????? 
//};
//AT+COPS=1,2,"46000" ????????????//?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? MNC
//OK
//AT+NEARFCN=0,3555 ????????????//???????????????????????????????????????????????????????????? 3555??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
//OK
//AT+CSCON=1 ????????????//??????????????????????????????????????????????????????????????????????????????????????????????????????????????
//OK
//AT+CEREG=1 ????????????//????????????????????????????????????????????????????????????????????????????????????????????????????????????????
//OK
//const String  AT_command_5310[6]={
//  "AT\n", //??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????  
//  "AT+CIMI\n",
//  "AT+CSQ\n",// ?????????????????????????????????????????????????????????????????????????
//  "AT+CEREG?\n",// ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
//  "AT+CGATT?\n",//????????????????????????????????????????????????? PS ??????????????????????????????????????????????????
//  "AT+CGATT?\n",//  
//};

const String  AT_command_5310[6]={
  "AT", //??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????  
  "AT+CIMI",
  "AT+CSQ",// ?????????????????????????????????????????????????????????????????????????
  "AT+CEREG?",// ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  "AT+CGATT?",//????????????????????????????????????????????????? PS ??????????????????????????????????????????????????
};

bool setup_M5310()
{
  NB_5310_RES res;
  DisMessage(0, "INIT M5310 AT", dc_white); //???????
  delay(2000);
  res = wait_rx_bc(AT_command_5310[0], 4000, "OK"); //  AT  --  OK
  if (res.status)
  {
    DisMessage(1, "M5310 POWER OK", dc_gre);
  }
  else
  {
    DisMessage(1, "M5310 POWER ERROR! SETUP quit!", dc_red);
    return (false);
  }
  delay(2000);

  delay(2000);
  // ??????????? 0~31??? CSQ???12?????????
  res = wait_rx_bc(AT_command_5310[2], 4000, "OK"); //   "AT+CSQ\n",  +CSQ:20,99
  if (res.status)
  {
    char ri;
    ri = res.temp.substring(6, 8).toInt();
    if ((ri > 12) && (ri != 99))
    {
      DisMessage(1, "CSQ:" + res.temp.substring(6, 8), dc_gre);
    }
    else
    {
      DisMessage(1, "No CSQ_sign,SETUP quit!" + res.data.substring(6, 8), dc_red);
      return (false);
    }
  }
  else
  {
    DisMessage(1, "CSQ REV ERROR! SETUP quit!", dc_red);
    return (false);
      } 
    delay(2000);  
   
  res = wait_rx_bc(AT_command_5310[3],4000,"OK");  //  NB?????????????????????????????????????????????????? +CEREG:0,1 (1-5)
   if(res.status) {
    char ri;
    ri = res.temp.substring(10).toInt();
    if ((ri >= 1) && (ri <= 5))
    {
      DisMessage(1, "NB+CEREG =" + res.temp.substring(10), dc_gre);
    }
    else
    {
      DisMessage(1, "NB+CEREG false,SETUP quit!", dc_red);
      return (false);
    }
  }
  else
  {
    DisMessage(1, "NB+CEREG REV ERROR! SETUP quit!", dc_red);
    return (false);
      } 
    delay(2000);
  res = wait_rx_bc(AT_command_5310[4],4000,"OK");  //  AT+CGATT?\n",//????????????????????????????????????????????????? PS ??????????????????????????????????????????????????  :1 ok  0:false    
   if(res.status) {
    if(res.temp.substring(8).toInt()==1)
      {DisMessage(1,"CGATT="+res.temp.substring(8),dc_gre);
       DisMessage(0,"M5310 NB_IOT OK!!!",dc_gre);      
      }
     else{
      DisMessage(1,"CGATT false,SETUP quit!",dc_red);  
      return (false);
    }
  }
  else
  {
    DisMessage(1, "CGATT ERROR! SETUP quit!", dc_red);
    return (false);
  }
}

// ?? ??????????????????? ???? ???? ?????

// ??????????????????????????? ????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? ???????????????????????????????????????????? ?????????????????????????????????????????????????? ????????????????????????????????????????????????????????

const String  AT_MIPLADDOBJ[4]={//??????????????????????????????????????????????????  // ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  "AT+MIPLCREATE=49,130031F10003F2002304001100000000000010123138332E3233302E34302E33393A35363833000131F300080000000000,0,49,0 ",  
  "AT+MIPLADDOBJ=0,3200,1,\"1\",0,1 ",   //???????????????????????????   ???????????????????????????????????????????????????????????????????????????????? Object 3200???????????????????ance 0 ???????????????????????????
  "AT+MIPLDISCOVERRSP=0,3200,1,4,\"5750\"",   //??????????????????????????? Resource??????????????????????????? ??????????????????????????????????????????????????????????????????????? Object3200???????????????????ance 0 ????????????? 5750 Resource ???????????????????????????
  "AT+MIPLOPEN=0,3000,30" ,     //????????????????????????????????????????????????    
};
bool  MIPLADDOBJ()
{  NB_5310_RES  res;   
   res=wait_rx_bc(AT_MIPLADDOBJ[0],3000,"+MIPLCREATE:0"); //  //?????????????????????????????????????????????????? ????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? 
    if(res.status) {
    DisMessage(1,"MIPLCREATE OK:"+res.temp,dc_gre);
    }
        else{                        
    DisMessage(1,"MIPLCREATE false???????????????????BJ quit!",dc_red);   
    return (false);
  }
  delay(2000);

   res=wait_rx_bc(AT_MIPLADDOBJ[1],3000,"OK"); //??????????????????????????? Object ???????????????????????????
    if(res.status) {
    DisMessage(1,"MMIPLADDOBJ OK:"+res.temp,dc_gre);
    }
        else{                        
    DisMessage(1,"ADDOBJ false???????????????????BJ quit!",dc_red);   
    return (false);
      } 
    delay(2000);    

   res=wait_rx_bc(AT_MIPLADDOBJ[2],3000,"OK"); //??????????????????????????? Resource???????????????????????????   
    if(res.status) {
    DisMessage(1,"MIPLDISCOVERRSP OK:"+res.temp,dc_gre);
    }  
        else{                        
    DisMessage(1,"DISCOVERRSP false???????????????????BJ quit!",dc_red);   
    return (false);
      } 
    delay(2000);
      
   res=wait_rx_bc(AT_MIPLADDOBJ[3],3000,"OK"); ////????????????????????????????????????????????????????????????3000 ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? ???????????????????????????30??????????????????????????????????????????????????????????????????????????????????????????? ???????????????????????????
    if(res.status) {
    DisMessage(1,"MIPLOPEN OK:"+res.temp,dc_gre);    
    }  
        else{                        
    DisMessage(1,"MIPLOPEN false???????????????????BJ quit!",dc_red);   
    return (false);
  }
  delay(2000);
}

  /*
??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? OBSERVE ????????????????????????????????? DISCOVER ?????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
[#Recv] +MIPLOBSERVE:0,39121,1,3200,0,-1
[#Recv] +MIPLDISCOVER:0,39122,3200
[#Recv] +MIPLREAD:0,39123,3,0,-1,0
????????????? ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????+MIPLEVENT:0,6 ???????????????????????????? ????????????????????????????????????????????????????????????????????????????????????????????????????????????
OneNET ????????????????????????????????????????????????? ????????????? ???????????????????????????????? ????????????????????????????????????????????????????????????????????????? ?????????????????????????????????? ????????????? OBSERVE ????????????????????????????????? ????????????? DISCOVER
???????????????????????????? ????????????? ???????????????????????????????????????????????????????????????????????????????? ??????????????????????????? ???????????????????????????
*/

const String  AT_MIPLNOTIFY[4]={                    // OneNET ????????????????????????????????????????????????????????????????????????
"AT+MIPLNOTIFY=0,0,3200,0,5750,1,4,\"177788\",0,0,12", //????????????????????????????id???????????????????d????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????   
"AT+MIPLREAD=0,60204,3200,0,5505,\"E309C82FE6\",1",     //Read ???????????????????????????????????????????????????????????????????????
"AT+MIPLWRITE=0,62069,1",                             //Write ???????????????????????????????????????????????????????????????????????
"AT+MIPLEXECUTE=0,46081,1",                           //Execute ???????????????????????????????????????????????????????????????????????    
};

const String  AT_MIPLCLOSE[3]={                   // OneNET ??????????????????????????????????????????????????????????????????????
"AT+MIPLCLOSE=0",           //??????????????????????????????????????????????????????????????????????
"AT+MIPLDELOBJ=0,3200,0",   //??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
"AT+MIPLDEL=0",             //???????????????????????????????????????????????????????????????????????????????????????????????????????????????  
};



